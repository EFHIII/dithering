<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quality Dithering</title>
  <link rel="stylesheet" href="src/app/style.css">

  <meta name="description" content="Dither images with any color palette">
  <meta name="keywords" content="dithering, wplace, generator, art, Minecraft, mapart, Pico8, mosaic, Rubik's Cube, map art, palette, posterize">
  <meta name="author" content="@EFHIII">
  <meta property="og:title" content="Quality Dithering">
  <meta property="og:description" content="Dither images with any color palette">
  <meta property="og:url" content="https://efhiii.github.io/dithering">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0" />
</head>

<body>
  <h1>Quality Dithering</h1>
  <div><a href="advanced">Advanced Version</a></div><br>
  <div class="blurb">
    This program includes several dithering algorithms, including some original ones. This suite is focused on accurate dithering over speed and as such its output is higher quality than most (if not all) other dithering apps.

    The scoring metric is the most unique thing here. It uses a perception kernel to approximate psychovisual perception. All the algorithms on this page except Burkes and Pattern-Dithering use this metric to direct the dithering process.
  </div>
  <div id="controls">
    <fieldset>
      <legend>General</legend>
      <div class="parameters">
        <label for="imageLoader1">Image to Dither</label>
        <input type="file" id="imageLoader1" name="imageLoader1" accept="image/*">
      </div>
      <div class="parameters">
        <label for="outputWidth">Output Width</label>
        <input type="number" id="outputWidth" name="outputWidth" value=""><br>
        <label for="outputHeight">Output Height</label>
        <input type="number" id="outputHeight" name="outputHeight" value="">
      </div>
      <div class="parameters">
        <label for="colorPalette">Color Palette</label>
        <select id="colorPalette" name="colorPalette"></select>
      </div>
      <div class="parameters" id="customPaletteGroup" style="display: none;">
        <label for="customPalette">Custom Palette</label><br>
        <input type="text" id="customPalette" name="customPalette" placeholder="e.g., #ff0000, #00ff00, #0000ff" oninput="processImage()">
      </div>
      <div class="parameters" id="generatePaletteGroup">
        <label for="generatePaletteSize">Generate Palette Size</label><br>
        <input type="number" id="generatePaletteSize" name="generatePaletteSize" value="12" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="advanced">Advanced settings</label>
        <input type="checkbox" id="advanced" name="advanced">
      </div>
    </fieldset>
    <fieldset>
      <legend>Palette Preview</legend>
      <div class="parameters">
        <canvas id="paletteCanvas"></canvas>
      </div>
    </fieldset>
    <fieldset>
      <legend>Preprocessing</legend>
      <div class="parameters">
        <label for="grayscale">Grayscale</label>
        <input type="checkbox" id="grayscale" name="grayscale" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="blackPoint">Black Point: <span id="blackPointText">0</span></label>
        <input type="range" name="blackPoint" id="blackPoint" value="0" min="0" max="255" step="1">
      </div>
      <div class="parameters">
        <label for="whitePoint">White Point: <span id="whitePointText">255</span></label>
        <input type="range" name="whitePoint" id="whitePoint" value="255" min="0" max="255" step="1">
      </div>
      <div class="parameters" id="patternDiv">
        <label for="pattern">Pattern</label>
        <select id="pattern" name="pattern" onchange="processImage()">
          <optgroup label="Saffron">
            <option value="saffronPatternSmooth">Saffron Smooth</option>
            <option value="saffronPatternAccurate">Saffron Accurate</option>
          </optgroup>
          <optgroup label="Adobe">
            <option value="patternDithering">Pattern Dithering</option>
          </optgroup>
          <optgroup label="Joel Yliluoma">
            <option value="JY1">Joel Yliluoma 1</option>
            <option value="JY2">Joel Yliluoma 2</option>
            <option value="JY3">Joel Yliluoma 3</option>
          </optgroup>
          <optgroup label="Simulated Annealing">
            <option value="greedyAnnealing">Greedy Annealing</option>
            <option value="randomAnnealing">Random Annealing</option>
          </optgroup>
        </select>
      </div>
      <div class="parameters" id="patternSizeDiv">
        <label for="patternSize">Pattern Size: <span id="patternSizeText">16</span></label>
        <input type="range" name="patternSize" id="patternSize" value="4" min="0" max="8" step="1" oninput="processImage()">
      </div>
    </fieldset>
    <fieldset id="kernelField" style="display: none">
      <legend>Kernel</legend>
      <div class="parameters">
        <label for="falloffFunction">Falloff Function</label>
        <select id="falloffFunction" name="falloffFunction">
          <option value="gaussianSpec">Gaussian Specular</option>
          <option value="gaussianSum" selected>Gaussian Sum</option>
          <option value="power">Power</option>
          <option value="inversePower">Inverse Power</option>
          <option value="reversePower">Reverse Power</option>
        </select>
      </div>
      <div class="parameters">
        <label for="distanceFunction">Distance Function</label>
        <select id="distanceFunction" name="distanceFunction" onchange="processImage()">
          <option value="manhattan">Manhattan Distance</option>
          <option value="euclidean" selected>Euclidean Distance</option>
          <option value="chebyshev">Chebyshev Distance</option>
        </select>
      </div>
      <div class="parameters">
        <label for="kernelSizeInput">Kernel Size</label>
        <input type="number" id="kernelSizeInput" name="kernelSizeInput" value="9" min="3" max="35" step="2" onchange="processImage()">
      </div>
    </fieldset>

    <fieldset id="gaussianSum" style="display: none">
      <legend>Sum of gaussians</legend>
      <div class="parameters">
        <label for="gaussianCount">Gaussians</label>
        <input type="number" id="gaussianCount" name="gaussianCount" value="2" min="1" max="10">
      </div>
      <div class="parameters">
        <label for="gaussianSumSpec">Specular</label>
        <input type="range" name="gaussianSumSpec" id="gaussianSumSpec" value="0.9" min="0" max="0.99" step="0.01" oninput="processImage()">
      </div>
      <div id="gaussianParams"></div>
    </fieldset>
    <fieldset id="gaussianSpec" style="display: none">
      <legend>Gaussian Specular</legend>
      <div class="parameters">
        <label for="gaussianSpecSize">Size</label>
        <input type="range" name="gaussianSpecSize" id="gaussianSpecSize" value="0.19" min="0" max="0.99" step="0.01" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="gaussianSpecSpec">Specular</label>
        <input type="range" name="gaussianSpecSpec" id="gaussianSpecSpec" value="0.5" min="0" max="0.99" step="0.01" oninput="processImage()">
      </div>
    </fieldset>
    <fieldset id="power" style="display: none">
      <legend>Power</legend>
      <div class="parameters">
        <label for="powerSize">Size</label>
        <input type="range" name="powerSize" id="powerSize" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="powerPower">Power</label>
        <input type="range" name="powerPower" id="powerPower" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
    </fieldset>
    <fieldset id="inversePower" style="display: none">
      <legend>Inverse Power</legend>
      <div class="parameters">
        <label for="inversePowerSize">Size</label>
        <input type="range" name="inversePowerSize" id="inversePowerSize" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="inversePowerPower">Power</label>
        <input type="range" name="inversePowerPower" id="inversePowerPower" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
    </fieldset>
    <fieldset id="reversePower" style="display: none">
      <legend>Reverse Power</legend>
      <div class="parameters">
        <label for="powerSize">Size</label>
        <input type="range" name="reversePowerSize" id="reversePowerSize" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
      <div class="parameters">
        <label for="reversePowerPower">Power</label>
        <input type="range" name="reversePowerPower" id="reversePowerPower" value="0.5" min="0" max="1" step="0.01" oninput="processImage()">
      </div>
    </fieldset>
    <fieldset id="kernelGraph" style="display: none">
      <legend>Kernel Graph</legend>
      <div class="parameters">
        <canvas id="kernelGraphCanvas"></canvas>
      </div>
    </fieldset>
    <fieldset id="kernelPreview" style="display: none">
      <legend>Kernel Preview</legend>
      <div class="parameters">
        <canvas id="kernelCanvas"></canvas>
      </div>
    </fieldset>
  </div>
  <hr>
  <div style="text-align: center; font-size: 1.5em; font-weight: bold;">Best<br><span id="bestAlg">N/A</span></div><hr>
  <div style="text-align: center; font-size: 1.5em; font-weight: bold;">Score of best<br><span id="score">N/A</span></div>
  <div style="color: #808080; font-size: 0.8em;">Lower is better</div>
  <hr>
  <div class="canvases">
    <fieldset>
      <legend>Target</legend>
      <canvas id="targetCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Burkes</legend>
      <canvas id="burkesCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Pattern Dithering</legend>
      <canvas id="patternDitheringCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Least Error Scan</legend>
      <canvas id="leastErrorScanCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Least Error First</legend>
      <canvas id="leastErrorFirstCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Energy Dithering (2 ppc)</legend>
      <canvas id="energyDitherCanvas"></canvas>
    </fieldset>
    <fieldset>
      <legend>Energy Dithering w/ Swaps (4 ppc)</legend>
      <canvas id="energyDitherSwapsCanvas"></canvas>
    </fieldset>
  </div><hr>
  <h2>About</h2>
  <div class="blurb">
    <b><i>Energy Dithering</i></b> is a technique that uses a simulated annealing process to attempt to find a high-quality local minimal to the scoring function. It's fairly slow, but the default values are tuned to work fairly well. You can adjust the settings in the Advanced Version.<br><br>
    <b><i>Least Error First</i></b> starts out assuming the image is as given and iteratively changes pixels to palette colors that would add the least amount of error among all possible pixels and palette colors. It is very slow, but works very well.<br><br>
    <b><i>Least Error Scan</i></b> is a modification of <i>Least Error First</i> that goes in scan-line order. It does several passes iteratively improving the image until it gets stuck at a local minima. That restriction makes it slightly worse, but significantly faster than <i>Least Error First</i>. The change is enough to make it tend to out-pace <i>Energy Dithering</i> until it gets stuck in a local minimal at which point <i>Energy Dithering</i> is able to overtake it.<br><br>
    <b><i>Pattern Dithering</i></b> and <b><i>Burkes (Error Diffusion)</i></b> are both existing algorithms, however I'm using the <a href="https://github.com/material-foundation/material-color-utilities/blob/main/typescript/hct/hct.ts" target="_blank">HCT</a> colorspace here so you'll likely get better results from this program than from those that don't use HCT. I'm also down-scaling images using a high-quality downscaling algorithm with all color-blending math done in Linear RGB.<br><br>
    <b><i>Pattern Dithering</i></b> requires a pattern and there are many pattern generating algorithms. Pattern Dithering isn't as good as algorithms that can diffuse error dynamically but they have a place and Joel Yliluoma has a great article on the topic: <a href="https://bisqwit.iki.fi/story/howto/dither/jy/">Joel Yliluoma's arbitrary-palette positional dithering algorithm</a>. The main algorithms mentioned in that article are available here as patterns under Preprocessing as well as a few others. In particular, <b><i>Saffron Smooth</i></b> is an algorithm I made that often gives very good results. It starts by assuming the entire pattern is the closest paletteColor and iteratively checks if replacing the first n (from n to 1) pattern entries with a different color improves the pattern's overall accuracy. Because it starts be demanding that as many entries as possible are replaced, it inherently disincentivizes colors that are starkly different from entering the pattern unless necessary. Adobe's Pattern Dithering is also very good.
  </div><br>
  <footer><a href="https://github.com/EFHIII/dithering">Code on GitHub</a></footer>
  <script type="module" src="src/app/simple-app.js"></script>
</body>

</html>
